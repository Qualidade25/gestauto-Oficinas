<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GestAuto Brasil - Busca de Oficinas</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #157f0d 0%, #105f0a 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .logo {
            color: white;
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .logo span {
            color: #ffd700;
        }

        .subtitle {
            color: rgba(255,255,255,0.9);
            font-size: 1.1rem;
            font-weight: 400;
        }

        .card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            overflow: hidden;
            margin-bottom: 30px;
        }

        .card-header {
            background: linear-gradient(135deg, #105f0a, #0b8006);
            padding: 25px 30px;
            color: white;
        }

        .card-header h1 {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .card-header p {
            opacity: 0.9;
            font-size: 0.95rem;
        }

        .filter-section {
            background: rgba(255,255,255,0.1);
            padding: 15px 20px;
            border-radius: 10px;
            margin-top: 15px;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .filter-label {
            font-weight: 500;
            font-size: 0.9rem;
        }

        .filter-select {
            padding: 8px 15px;
            border: none;
            border-radius: 8px;
            background: white;
            color: #2c3e50;
            font-size: 0.9rem;
            cursor: pointer;
        }

        .card-body {
            padding: 30px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 25px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #2c3e50;
            font-size: 0.9rem;
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e8ecef;
            border-radius: 12px;
            font-size: 0.95rem;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }

        .form-control:focus {
            outline: none;
            border-color: #157f0d;
            background: white;
            box-shadow: 0 0 0 3px rgba(21, 127, 13, 0.1);
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 12px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #157f0d, #105f0a);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(21, 127, 13, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #0b8006, #157f0d);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(11, 128, 6, 0.4);
        }

        .btn-outline {
            background: transparent;
            border: 2px solid #bdc3c7;
            color: #7f8c8d;
        }

        .btn-outline:hover {
            border-color: #95a5a6;
            color: #34495e;
        }

        .button-group {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            border-radius: 4px;
            border: 2px solid #bdc3c7;
        }

        .checkbox-group label {
            margin: 0;
            font-size: 0.9rem;
            color: #7f8c8d;
        }

        .status-box {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 15px 20px;
            margin-bottom: 20px;
            border-left: 4px solid #157f0d;
        }

        .status-loading {
            border-left-color: #f39c12;
            background: #fef9e7;
        }

        .status-success {
            border-left-color: #157f0d;
            background: #f0f9f0;
        }

        .status-error {
            border-left-color: #e74c3c;
            background: #fdedec;
        }

        .error-box {
            background: #fdedec;
            border: 1px solid #e74c3c;
            border-radius: 12px;
            padding: 15px 20px;
            margin-bottom: 20px;
            color: #c0392b;
            font-size: 0.9rem;
        }

        .table-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            overflow: hidden;
            margin-top: 20px;
        }

        .table-header {
            background: linear-gradient(135deg, #105f0a, #0b8006);
            padding: 20px 25px;
            color: white;
        }

        .table-header h3 {
            font-size: 1.2rem;
            font-weight: 600;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: #f8f9fa;
        }

        th {
            padding: 15px 12px;
            text-align: left;
            font-weight: 600;
            color: #2c3e50;
            font-size: 0.85rem;
            border-bottom: 2px solid #e8ecef;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid #e8ecef;
            font-size: 0.9rem;
            color: #2c3e50;
        }

        tbody tr:hover {
            background: #f8f9fa;
        }

        .position-badge {
            background: linear-gradient(135deg, #157f0d, #105f0a);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-ativo {
            background: #27ae60;
        }

        .status-inativo {
            background: #e74c3c;
        }

        .maps-link {
            color: #157f0d;
            text-decoration: none;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .maps-link:hover {
            text-decoration: underline;
        }

        .debug-panel {
            background: #1a1a1a;
            border-radius: 12px;
            overflow: hidden;
            margin-top: 30px;
        }

        .debug-header {
            background: #105f0a;
            padding: 15px 20px;
            color: white;
            font-weight: 600;
        }

        .debug-content {
            padding: 20px;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            max-height: 300px;
            overflow-y: auto;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #157f0d;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: linear-gradient(135deg, #157f0d, #0b8006);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.85rem;
            opacity: 0.9;
        }

        .success-text {
            color: #157f0d;
            font-weight: 600;
        }

        .loading-text {
            color: #f39c12;
            font-weight: 600;
        }

        .error-text {
            color: #e74c3c;
            font-weight: 600;
        }

        .local-mode-warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 10px 15px;
            margin-bottom: 15px;
            color: #856404;
            font-size: 0.85rem;
        }

        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .button-group {
                flex-direction: column;
                align-items: stretch;
            }
            
            .card-body {
                padding: 20px;
            }
            
            .table-container {
                overflow-x: auto;
            }
            
            .filter-group {
                flex-direction: column;
                align-items: flex-start;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="logo">GestAuto<span>Brasil</span></div>
            <div class="subtitle">Sistema Inteligente de Busca de Oficinas</div>
        </div>

        <!-- Main Card -->
        <div class="card">
            <div class="card-header">
                <h1>Busca de Oficinas - Top 10</h1>
                <p>Encontre as melhores oficinas próximas ao CEP informado</p>
                
                <!-- Filtro por Setor -->
                <div class="filter-section">
                    <div class="filter-group">
                        <span class="filter-label">🔧 Filtrar por Setor:</span>
                        <select id="filterSetor" class="filter-select">
                            <option value="todos">Todos os Setores</option>
                            <option value="Movida">Movida</option>
                            <option value="Multimarcas">Multimarcas</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="card-body">
                <!-- Aviso Modo Local -->
                <div id="localModeWarning" class="local-mode-warning" style="display: none;">
                    ⚠️ <strong>Modo Local Detectado:</strong> Para conexão com a planilha, use um servidor web. 
                    <a href="#" id="showServerInstructions" style="color: #157f0d; font-weight: bold;">Clique aqui para instruções</a>
                </div>

                <!-- Instruções Servidor -->
                <div id="serverInstructions" class="local-mode-warning" style="display: none;">
                    <strong>📋 Como usar servidor local:</strong><br>
                    1. <strong>Python:</strong> Abra terminal na pasta e digite: <code>python -m http.server 8000</code><br>
                    2. <strong>Node.js:</strong> Instale com <code>npm install -g http-server</code> depois <code>http-server</code><br>
                    3. <strong>Extensão Chrome:</strong> Instale "Web Server for Chrome"<br>
                    4. Acesse via: <code>http://localhost:8000</code>
                </div>

                <!-- Form Section -->
                <div class="form-grid">
                    <div class="form-group">
                        <label for="cepInput">📍 CEP de Origem</label>
                        <input type="text" id="cepInput" class="form-control" placeholder="Ex: 01311-000">
                    </div>
                    
                    <div class="form-group">
                        <label for="sheetUrl">🔗 URL da Planilha</label>
                        <input type="url" id="sheetUrl" class="form-control" 
                               value="https://docs.google.com/spreadsheets/d/e/2PACX-1vRzl3PdvxEtsEDFBqGf02U9MApfktgc2LWfcq5pXzpGKu6D4wxpfg9AEdMppbMCx2cQjkvPOMEivlns/pubhtml">
                    </div>
                </div>

                <!-- Options -->
                <div class="checkbox-group">
                    <input type="checkbox" id="useSample">
                    <label for="useSample">Usar dados de exemplo (fallback)</label>
                </div>

                <!-- Buttons -->
                <div class="button-group">
                    <button id="buscar" class="btn btn-primary">
                        <span>🔍 Buscar Top 10 Oficinas</span>
                    </button>
                    <button id="testarConexao" class="btn btn-success">
                        <span>📡 Testar Conexão</span>
                    </button>
                    <button id="limpar" class="btn btn-outline">
                        <span>🔄 Limpar</span>
                    </button>
                </div>

                <!-- Status -->
                <div id="status" class="status-box">
                    Pronto. Insira o CEP de origem e clique em Buscar Top 10.
                </div>

                <!-- Error Box -->
                <div id="errorBox"></div>

                <!-- Stats Grid -->
                <div id="statsGrid" class="stats-grid" style="display: none;">
                    <div class="stat-card">
                        <div class="stat-number" id="statOficinas">0</div>
                        <div class="stat-label">Oficinas Encontradas</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="statCidade">-</div>
                        <div class="stat-label">Cidade da Busca</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="statRegistros">0</div>
                        <div class="stat-label">Registros Processados</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="statSetor">Todos</div>
                        <div class="stat-label">Setor Filtrado</div>
                    </div>
                </div>

                <!-- Results Table -->
                <div id="resultContainer" style="display: none;">
                    <div class="table-container">
                        <div class="table-header">
                            <h3>🏆 Top 10 Melhores Oficinas</h3>
                        </div>
                        <table id="resultTable">
                            <thead>
                                <tr>
                                    <th>Posição</th>
                                    <th>Status</th>
                                    <th>Oficina</th>
                                    <th>WhatsApp</th>
                                    <th>Endereço</th>
                                    <th>Cidade</th>
                                    <th>CEP</th>
                                    <th>Distância</th>
                                    <th>Placas</th>
                                    <th>Ticket Médio</th>
                                    <th>Volume</th>
                                    <th>Setor</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Debug Panel -->
        <div class="debug-panel">
            <div class="debug-header">
                💻 Console de Desenvolvimento
            </div>
            <pre id="debug" class="debug-content">—</pre>
        </div>
    </div>

    <script>
        // --- Helpers ---
        const el = id => document.getElementById(id);
        const DEFAULT_SHEET_URL = el('sheetUrl').value;

        // Mapeamento de CEP para cidade
        let cepToCityMap = new Map();
        let currentRows = [];
        let currentCepOrigem = '';
        let currentCidadeOrigem = '';

        // Detectar se está em modo local
        const isLocalFile = window.location.protocol === 'file:';
        
        if (isLocalFile) {
            el('localModeWarning').style.display = 'block';
        }

        // Mostrar instruções do servidor
        el('showServerInstructions').addEventListener('click', (e) => {
            e.preventDefault();
            el('serverInstructions').style.display = 'block';
        });

        // Elementos de UI
        el('limpar').addEventListener('click', () => {
            el('cepInput').value = '';
            el('resultContainer').style.display = 'none';
            el('statsGrid').style.display = 'none';
            el('debug').textContent = '—';
            updateStatus('Pronto. Insira o CEP de origem e clique em Buscar Top 10.', 'default');
            el('errorBox').innerHTML = '';
            currentRows = [];
        });

        // Filtro por setor
        el('filterSetor').addEventListener('change', () => {
            if (currentRows.length > 0 && currentCepOrigem && currentCidadeOrigem) {
                updateStatus('<span class="loading-spinner"></span> Aplicando filtro...', 'loading');
                setTimeout(() => {
                    processRows(currentRows, currentCepOrigem, currentCidadeOrigem);
                }, 100);
            }
        });

        // Testar conexão
        el('testarConexao').addEventListener('click', () => {
            updateStatus('<span class="loading-spinner"></span> Testando conexão com a planilha...', 'loading');
            el('errorBox').innerHTML = '';
            
            const url = el('sheetUrl').value;
            fetchSheetData(url)
                .then(rows => {
                    updateStatus(`<span class="success-text">✅ Conexão bem-sucedida! ${rows.length} registros carregados.</span>`, 'success');
                    el('debug').textContent = `Dados carregados com sucesso. Primeiras 3 linhas:\n\n${JSON.stringify(rows.slice(0, 3), null, 2)}`;
                })
                .catch(error => {
                    updateStatus('<span class="error-text">❌ Falha na conexão</span>', 'error');
                    showError(`Erro ao conectar: ${error.message}`);
                    
                    // Sugerir usar dados de exemplo
                    if (isLocalFile) {
                        showError(`Erro ao conectar: ${error.message}<br><br>
                        <strong>Solução:</strong> Use um servidor web local ou marque "Usar dados de exemplo"`);
                    }
                });
        });

        // Buscar
        el('buscar').addEventListener('click', async () => {
            el('errorBox').innerHTML = '';
            updateStatus('<span class="loading-spinner"></span> Buscando Top 10 oficinas...', 'loading');

            const cepRaw = (el('cepInput').value || '').replace(/\D/g,'');
            
            if (cepRaw.length < 5) {
                showError('Informe um CEP válido para a busca.');
                return;
            }

            try {
                // Primeiro buscar a cidade do CEP informado
                const cidadeOrigem = await buscarCidadePorCEP(cepRaw);
                updateStatus(`<span class="loading-spinner"></span> Buscando oficinas em ${cidadeOrigem}...`, 'loading');

                const useSample = el('useSample').checked;
                const url = el('sheetUrl').value;

                let rows;
                if (useSample) {
                    rows = getSampleData();
                    el('debug').textContent = 'Usando dados de exemplo.';
                } else {
                    rows = await fetchSheetData(url);
                    el('debug').textContent = `Dados carregados: ${rows.length} registros`;
                }

                currentRows = rows;
                currentCepOrigem = cepRaw;
                currentCidadeOrigem = cidadeOrigem;

                processRows(rows, cepRaw, cidadeOrigem);
                
            } catch (error) {
                console.error('Erro na busca:', error);
                showError(`Erro na busca: ${error.message}`);
                updateStatus('<span class="error-text">Erro na busca</span>', 'error');
            }
        });

        // Função para buscar cidade por CEP
        async function buscarCidadePorCEP(cep) {
            cep = cep.replace(/\D/g, '');
            
            if (cepToCityMap.has(cep)) {
                return cepToCityMap.get(cep);
            }

            try {
                const response = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
                
                if (!response.ok) {
                    throw new Error('Erro ao consultar CEP');
                }
                
                const data = await response.json();
                
                if (data.erro) {
                    throw new Error('CEP não encontrado');
                }
                
                const cidade = data.localidade.toUpperCase();
                cepToCityMap.set(cep, cidade);
                
                return cidade;
                
            } catch (error) {
                throw new Error(`Não foi possível determinar a cidade do CEP ${cep}: ${error.message}`);
            }
        }

        // Função para buscar dados da planilha - ATUALIZADA COM COLUNAS AN E AO
        async function fetchSheetData(url) {
            return new Promise((resolve, reject) => {
                const csvUrl = url.replace('/pubhtml', '') + '/pub?output=csv';
                
                fetch(csvUrl)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }
                        return response.text();
                    })
                    .then(csvText => {
                        try {
                            const rows = parseCSV(csvText);
                            if (rows.length === 0) {
                                throw new Error('Planilha vazia ou sem dados');
                            }
                            resolve(rows);
                        } catch (parseError) {
                            reject(new Error(`Erro ao processar dados: ${parseError.message}`));
                        }
                    })
                    .catch(error => {
                        reject(new Error(`Falha ao carregar: ${error.message}`));
                    });
            });
        }

        // Parser CSV - ATUALIZADO COM COLUNAS AN E AO
        function parseCSV(csvText) {
            const lines = csvText.split('\n').filter(line => line.trim() !== '');
            if (lines.length < 2) return [];

            const rows = [];
            
            for (let i = 1; i < lines.length; i++) {
                const values = parseCSVLine(lines[i]);
                
                // Mapeamento das colunas: A=0, B=1, C=2, D=3, E=4, F=5, G=6, T=19, AH=33, AM=38, AN=39, AO=40
                const row = {
                    // Coluna A (0) - Nome original da oficina
                    oficina_original: values[0] || '',
                    whatsapp: values[1] || '',  
                    endereco: values[2] || '',
                    numero: values[3] || '',
                    cidade: values[4] || '',
                    estado: values[5] || '',
                    cep: values[6] || '',
                    placa: values[19] || '',
                    valor_aprovado: values[33] || '0',
                    setor: values[38] || '',
                    // NOVAS COLUNAS:
                    status: values[39] || '', // Coluna AN - Status (ATIVO/INATIVO)
                    oficina_nome: values[40] || '' // Coluna AO - Nome preferencial da oficina
                };
                
                // Usar nome da coluna AO, se vazio usar coluna A
                row.oficina = row.oficina_nome.trim() || row.oficina_original.trim();
                
                if (row.oficina || row.placa.trim()) {
                    rows.push(row);
                }
            }
            
            return rows;
        }

        function parseCSVLine(line) {
            const values = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                const nextChar = line[i + 1];
                
                if (char === '"') {
                    if (inQuotes && nextChar === '"') {
                        current += '"';
                        i++;
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    values.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            
            values.push(current);
            return values;
        }

        // Processar dados com filtro de setor
        function processRows(rows, cepRaw, cidadeOrigem) {
            try {
                const setorFiltro = el('filterSetor').value;
                let rowsFiltradas = rows;

                // Aplicar filtro de setor se não for "todos"
                if (setorFiltro !== 'todos') {
                    rowsFiltradas = rows.filter(row => {
                        const setorRow = (row.setor || '').toString().trim();
                        return setorRow.toLowerCase() === setorFiltro.toLowerCase();
                    });
                }

                const grouped = agruparOficinas(rowsFiltradas);
                const ranked = rankTop10(grouped, cepRaw, cidadeOrigem);
                renderTable(ranked, cidadeOrigem, rows.length, setorFiltro);
            } catch (error) {
                showError(`Erro ao processar dados: ${error.message}`);
                updateStatus('<span class="error-text">Erro no processamento</span>', 'error');
            }
        }

        // Agrupar oficinas - ATUALIZADO COM STATUS E CÁLCULO CORRIGIDO
        function agruparOficinas(rows) {
            const mapa = new Map();
            
            rows.forEach(r => {
                const nome = r.oficina || 'Desconhecida';
                const cep = (r['cep'] || '').toString().replace(/\D/g,'');
                const cidade = (r['cidade'] || '').toString().toUpperCase();
                const estado = (r['estado'] || '').toString();
                const endereco = (r['endereco'] || '').toString();
                const numero = (r['numero'] || '').toString();
                const whatsapp = (r['whatsapp'] || '').toString();
                const placa = (r['placa'] || '').toString().trim();
                const valor = parseMoney(r['valor_aprovado'] || 0);
                const setor = (r['setor'] || '').toString();
                const status = (r['status'] || '').toString().toUpperCase();

                if (!mapa.has(nome)) {
                    mapa.set(nome, {
                        nome, cep, cidade, estado, endereco, numero, whatsapp, 
                        valores: [], 
                        placas: new Set(), 
                        setores: new Set(), 
                        status: new Set(),
                        setor
                    });
                }
                
                const off = mapa.get(nome);
                
                // CORREÇÃO: Só adiciona valor se for maior que zero
                if (valor > 0) {
                    off.valores.push(valor);
                }
                
                if (placa) off.placas.add(placa);
                if (setor) off.setores.add(setor);
                if (status) off.status.add(status);
                if (!off.cep && cep) off.cep = cep;
                if (!off.cidade && cidade) off.cidade = cidade;
                if (!off.estado && estado) off.estado = estado;
            });

            return Array.from(mapa.values()).map(o => {
                const qtdPlacasDistintas = o.placas.size;
                
                // CORREÇÃO DO TICKET MÉDIO: Considera apenas valores > 0
                const valoresValidos = o.valores.filter(v => v > 0);
                const valorTotal = valoresValidos.reduce((a, b) => a + b, 0);
                
                // Ticket médio = Valor Total / Quantidade de Placas Distintas (apenas se tiver valores válidos)
                const ticketMedio = qtdPlacasDistintas > 0 && valoresValidos.length > 0 
                    ? valorTotal / qtdPlacasDistintas 
                    : 0;

                // Determinar status predominante
                const statusArray = Array.from(o.status);
                const statusFinal = statusArray.includes('ATIVO') ? 'ATIVO' : 
                                  statusArray.includes('INATIVO') ? 'INATIVO' : 'INDEFINIDO';

                return {
                    nome: o.nome,
                    cep: o.cep || '',
                    cidade: o.cidade || '',
                    estado: o.estado || '',
                    endereco: o.endereco || '',
                    numero: o.numero || '',
                    whatsapp: o.whatsapp || '',
                    setor: Array.from(o.setores).join(', '),
                    status: statusFinal,
                    volume: o.valores.length,
                    qtdPlacas: qtdPlacasDistintas,
                    valorTotal: valorTotal,
                    ticketMedio: ticketMedio,
                    valoresValidos: valoresValidos.length // Para debug
                };
            });
        }

        // Parse dinheiro
        function parseMoney(v) {
            if (v == null) return 0;
            if (typeof v === 'number') return v;
            
            let s = v.toString()
                .replace(/\s/g, '')
                .replace(/[R$\\.]/g, '')
                .replace(',', '.');
            
            const n = parseFloat(s);
            return isNaN(n) ? 0 : n;
        }

        // Calcular similaridade do CEP
        function calcularSimilaridadeCEP(cep1, cep2) {
            if (!cep1 || !cep2) return 0;
            
            cep1 = cep1.replace(/\D/g, '');
            cep2 = cep2.replace(/\D/g, '');
            
            let similaridade = 0;
            
            if (cep1 === cep2) return 1000;
            
            for (let i = 0; i < Math.min(cep1.length, cep2.length); i++) {
                if (cep1[i] === cep2[i]) {
                    similaridade += 10 * (8 - i);
                }
            }
            
            return similaridade;
        }

        // Gerar link do Google Maps
        function gerarLinkMaps(cepOrigem, cepDestino) {
            if (!cepOrigem || !cepDestino) return '#';
            const origem = cepOrigem.replace(/\D/g, '');
            const destino = cepDestino.replace(/\D/g, '');
            return `https://www.google.com/maps/dir/${origem}/${destino}`;
        }

        // Ranking TOP 10
        function rankTop10(oficinas, cepOrigem, cidadeOrigem) {
            const oficinasMesmaCidade = oficinas.filter(o => 
                o.cidade.toUpperCase() === cidadeOrigem.toUpperCase()
            );
            
            if (oficinasMesmaCidade.length === 0) {
                throw new Error(`Nenhuma oficina encontrada na cidade ${cidadeOrigem}`);
            }
            
            return oficinasMesmaCidade.map(o => {
                const similaridadeCEP = calcularSimilaridadeCEP(cepOrigem, o.cep);
                const ticketMedio = o.ticketMedio || 0;
                const volume = o.volume || 0;
                
                const scoreCEP = similaridadeCEP;
                const scoreTicket = ticketMedio > 0 ? (1000000 / ticketMedio) : 0;
                const scoreVolume = volume * 100;
                
                const scoreFinal = (scoreCEP * 0.5) + (scoreTicket * 0.3) + (scoreVolume * 0.2);
                
                return {
                    ...o,
                    similaridadeCEP,
                    scoreFinal
                };
            })
            .sort((a, b) => b.scoreFinal - a.scoreFinal)
            .slice(0, 10);
        }

        // Renderizar tabela - ATUALIZADA COM STATUS
        function renderTable(rows, cidadeOrigem, totalRegistros, setorFiltro) {
            const table = el('resultTable');
            const tbody = table.querySelector('tbody');
            tbody.innerHTML = '';
            
            if (rows.length === 0) {
                el('resultContainer').style.display = 'none';
                showError(`Nenhuma oficina encontrada em ${cidadeOrigem} com os critérios especificados.`);
                return;
            }
            
            rows.forEach((r, index) => {
                const tr = document.createElement('tr');
                const mapsLink = gerarLinkMaps(currentCepOrigem, r.cep);
                const statusClass = r.status === 'ATIVO' ? 'status-ativo' : 
                                  r.status === 'INATIVO' ? 'status-inativo' : 'status-inativo';
                const statusText = r.status === 'ATIVO' ? 'ATIVO' : 
                                 r.status === 'INATIVO' ? 'INATIVO' : 'INDEFINIDO';
                
                tr.innerHTML = `
                    <td><div class="position-badge">${index + 1}º</div></td>
                    <td>
                        <span class="status-indicator ${statusClass}" title="${statusText}"></span>
                        ${statusText}
                    </td>
                    <td><strong>${escapeHtml(r.nome)}</strong></td>
                    <td>${escapeHtml(formatWhatsApp(r.whatsapp))}</td>
                    <td>${escapeHtml(r.endereco)} ${escapeHtml(r.numero)}</td>
                    <td>${escapeHtml(r.cidade)}/${escapeHtml(r.estado)}</td>
                    <td>${escapeHtml(formatCep(r.cep))}</td>
                    <td>
                        <a href="${mapsLink}" target="_blank" class="maps-link" title="Ver rota no Google Maps">
                            🗺️ Rota
                        </a>
                    </td>
                    <td>${r.qtdPlacas}</td>
                    <td><strong>${formatMoney(r.ticketMedio)}</strong></td>
                    <td>${r.volume}</td>
                    <td>${escapeHtml(r.setor)}</td>
                `;
                tbody.appendChild(tr);
            });
            
            // Atualizar stats
            el('statOficinas').textContent = rows.length;
            el('statCidade').textContent = cidadeOrigem;
            el('statRegistros').textContent = totalRegistros.toLocaleString();
            el('statSetor').textContent = setorFiltro === 'todos' ? 'Todos' : setorFiltro;
            
            el('resultContainer').style.display = 'block';
            el('statsGrid').style.display = 'grid';
            updateStatus(`<span class="success-text">✅ Busca concluída! ${rows.length} oficinas encontradas em ${cidadeOrigem}</span>`, 'success');
        }

        // Utilitários
        function formatCep(s) { 
            s = (s || '').toString().replace(/\D/g, ''); 
            return s.length === 8 ? s.slice(0, 5) + '-' + s.slice(5) : s; 
        }

        function formatWhatsApp(whatsapp) {
            const num = whatsapp.replace(/\D/g, '');
            if (num.length === 11) {
                return `(${num.slice(0,2)}) ${num.slice(2,7)}-${num.slice(7)}`;
            }
            return whatsapp;
        }

        function formatMoney(v) { 
            return 'R$ ' + Number(v || 0).toLocaleString('pt-BR', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }); 
        }

        function escapeHtml(s) { 
            return (s || '').toString()
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        function updateStatus(message, type = 'default') {
            const statusEl = el('status');
            statusEl.innerHTML = message;
            statusEl.className = 'status-box';
            
            if (type === 'loading') statusEl.classList.add('status-loading');
            if (type === 'success') statusEl.classList.add('status-success');
            if (type === 'error') statusEl.classList.add('status-error');
        }

        function showError(msg) { 
            el('errorBox').innerHTML = '<div class="error-box">' + escapeHtml(msg).replace(/\n/g, '<br>') + '</div>'; 
        }

        // Dados de exemplo ATUALIZADOS com status
        function getSampleData() {
            return [
                {"oficina_original":"OFICINA CENTRO","oficina_nome":"OFICINA CENTRO PLUS","whatsapp":"11999999999","endereco":"RUA PRINCIPAL","numero":"123","cidade":"SÃO PAULO","estado":"SP","cep":"01311000","placa":"ABC1D23","valor_aprovado":"1500.50","setor":"Multimarcas","status":"ATIVO"},
                {"oficina_original":"OFICINA ZONA SUL","oficina_nome":"","whatsapp":"11888888888","endereco":"AV PAULISTA","numero":"456","cidade":"SÃO PAULO","estado":"SP","cep":"01311010","placa":"XYZ9W87","valor_aprovado":"2300.75","setor":"Movida","status":"ATIVO"},
                {"oficina_original":"MECÂNICA RÁPIDA","oficina_nome":"MECÂNICA EXPRESS","whatsapp":"11777777777","endereco":"RUA TESTE","numero":"789","cidade":"SÃO PAULO","estado":"SP","cep":"01311020","placa":"DEF4G56","valor_aprovado":"1800.00","setor":"Multimarcas","status":"INATIVO"},
                {"oficina_original":"AUTO CENTER SP","oficina_nome":"","whatsapp":"11666666666","endereco":"RUA EXEMPLO","numero":"100","cidade":"SÃO PAULO","estado":"SP","cep":"01311030","placa":"GHI7H89","valor_aprovado":"1200.00","setor":"Multimarcas","status":"ATIVO"},
                {"oficina_original":"OFICINA QUALIDADE","oficina_nome":"OFICINA PREMIUM","whatsapp":"11555555555","endereco":"AV BRASIL","numero":"200","cidade":"SÃO PAULO","estado":"SP","cep":"01311040","placa":"JKL0I12","valor_aprovado":"3000.00","setor":"Movida","status":"ATIVO"},
                {"oficina_original":"MECÂNICA BARATA","oficina_nome":"","whatsapp":"11444444444","endereco":"RUA ECONOMIA","numero":"50","cidade":"SÃO PAULO","estado":"SP","cep":"01311000","placa":"MNO3P45","valor_aprovado":"800.00","setor":"Multimarcas","status":"INATIVO"},
                {"oficina_original":"OFICINA EXPRESS","oficina_nome":"OFICINA EXPRESS 24H","whatsapp":"11333333333","endereco":"AV RÁPIDA","numero":"300","cidade":"SÃO PAULO","estado":"SP","cep":"01311010","placa":"PQR6S78","valor_aprovado":"2500.00","setor":"Movida","status":"ATIVO"},
                {"oficina_original":"AUTO MECÂNICA","oficina_nome":"","whatsapp":"11222222222","endereco":"RUA OFICINAS","numero":"75","cidade":"SÃO PAULO","estado":"SP","cep":"01311020","placa":"STU9V01","valor_aprovado":"1600.00","setor":"Multimarcas","status":"ATIVO"},
                {"oficina_original":"OFICINA TOP","oficina_nome":"OFICINA TOP QUALITY","whatsapp":"11111111111","endereco":"AV QUALIDADE","numero":"400","cidade":"SÃO PAULO","estado":"SP","cep":"01311030","placa":"VWX2Y34","valor_aprovado":"2800.00","setor":"Movida","status":"ATIVO"},
                {"oficina_original":"MECÂNICA CONFIÁVEL","oficina_nome":"","whatsapp":"11000000000","endereco":"RUA CONFIANÇA","numero":"150","cidade":"SÃO PAULO","estado":"SP","cep":"01311040","placa":"YZA5B67","valor_aprovado":"1900.00","setor":"Multimarcas","status":"INATIVO"}
            ];
        }
    </script>
</body>
</html>